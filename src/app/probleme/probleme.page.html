<ion-content class="ion-padding">

  <div class="welcome-header">
    <h1 class="page-title">Signaler un problème</h1>
    <p class="subtitle">Sélectionnez votre voiture et les problèmes rencontrés</p>
  </div>
  

  <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-container">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Chargement...</p>
    </div>

  <!-- Error State -->
  <div *ngIf="errorMessage" class="error-message">
    <ion-icon name="warning-outline"></ion-icon>
    <p>{{errorMessage}}</p>
  </div>

  <!-- Main Form -->
  <form *ngIf="!isLoading && !errorMessage" [formGroup]="problemeForm" (ngSubmit)="soumettreProbleme()">
    
    <!-- Sélection de la voiture -->
    <ion-card class="form-section">
      <ion-card-header>
        <ion-card-title>1. Sélectionnez votre voiture</ion-card-title>
      </ion-card-header>
      
      <ion-card-content>
        <ion-item>
          <ion-label position="floating">Véhicule*</ion-label>
          <ion-select 
            formControlName="idVoiture" 
            interface="action-sheet"
            (ionChange)="onVoitureChange($event)"
          >
            <ion-select-option *ngFor="let voiture of voitures" [value]="voiture.id">
              {{voiture.marque || 'Voiture'}} {{voiture.modele || ''}} - {{voiture.matricule}}
              <span *ngIf="voiture.annee">({{voiture.annee}})</span>
            </ion-select-option>
          </ion-select>
        </ion-item>
        
        <!-- Info voiture sélectionnée -->
        <div *ngIf="voitureSelectionnee" class="selected-car-info">
          <ion-icon name="car-outline"></ion-icon>
          <div class="car-details">
            <strong>{{voitureSelectionnee.marque || 'Voiture'}} {{voitureSelectionnee.modele || ''}}</strong>
            <p>Matricule: {{voitureSelectionnee.matricule}}</p>
            <p *ngIf="voitureSelectionnee.annee">Année: {{voitureSelectionnee.annee}}</p>
          </div>
        </div>
        
        <!-- Avertissement si panne déjà existante -->
        <div *ngIf="panneExistante" class="warning-message">
          <ion-icon name="alert-circle-outline"></ion-icon>
          <p>⚠️ Une panne est déjà enregistrée pour cette voiture</p>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Sélection des problèmes -->
    <ion-card class="form-section">
      <ion-card-header>
        <ion-card-title>2. Sélectionnez les problèmes</ion-card-title>
        <!-- <ion-card-subtitle>Vous pouvez sélectionner plusieurs problèmes</ion-card-subtitle> -->
      </ion-card-header>
      
      <ion-card-content>
        <!-- Filtre de recherche -->
        <ion-searchbar 
          placeholder="Rechercher un problème..." 
          (ionInput)="filtrerPannes($event)"
          class="search-bar"
        ></ion-searchbar>

        <!-- Liste des problèmes -->
        <div class="panne-types-container">
          <div *ngFor="let panneType of panneTypesFiltres" 
               class="panne-type-item"
               [class.selected]="estSelectionnee(panneType.id)"
               (click)="toggleSelection(panneType.id)">
            
            <div class="panne-type-header">
              <ion-checkbox 
                [checked]="estSelectionnee(panneType.id)"
                (ionChange)="toggleSelection(panneType.id)"
              ></ion-checkbox>
              <h3>{{panneType.nom}}</h3>
              <span class="price-badge">{{panneType.prix}} Ar</span>
            </div>
            
            <div class="panne-type-details">
              <p class="description">{{panneType.description || 'Pas de description'}}</p>
              <div class="panne-type-meta">
                <span class="duration">
                  <ion-icon name="time-outline"></ion-icon>
                  {{panneType.duree}}h estimée
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Message si aucun problème sélectionné -->
        <div *ngIf="problemeForm.get('panneTypesIds')?.value?.length === 0" class="no-selection-message">
          <!-- <ion-icon name="information-circle-outline"></ion-icon> -->
          <p>Sélectionnez au moins un problème</p>
        </div>
        
        <!-- Liste des problèmes sélectionnés -->
        <div *ngIf="problemeForm.get('panneTypesIds')?.value?.length > 0" class="selected-items-container">
          <h4>Problèmes sélectionnés ({{problemeForm.get('panneTypesIds')?.value?.length}}):</h4>
          <div class="selected-items-list">
            <ion-chip *ngFor="let panneId of problemeForm.get('panneTypesIds')?.value" color="primary">
              <ion-label>{{getPanneTypeName(panneId)}}</ion-label>
              <ion-icon name="close" (click)="removeSelection(panneId)"></ion-icon>
            </ion-chip>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Résumé et bouton de soumission -->
    <ion-card class="summary-section">
      <ion-card-content>
        <div class="summary-header">
          <h3>Résumé</h3>
          <ion-badge color="primary" *ngIf="problemeForm.get('panneTypesIds')?.value?.length > 0">
            {{problemeForm.get('panneTypesIds')?.value?.length}} problème(s)
          </ion-badge>
        </div>
        
        <div class="summary-content">
          <!-- Prix total -->
          <div class="total-price" *ngIf="getTotalPrix() > 0">
            <span>Total estimé:</span>
            <span class="price-badge">{{getTotalPrix()}} Ar</span>
          </div>
          
          <!-- Durée totale -->
          <div class="total-duration" *ngIf="getTotalDuree() > 0">
            <span>Durée estimée:</span>
            <span class="duration">{{getTotalDuree()}} heures</span>
          </div>
          
          <!-- Bouton de soumission -->
          <ion-button 
            expand="block" 
            type="submit" 
            class="submit-button"
            [disabled]="!problemeForm.valid || isSubmitting"
            [color]="problemeForm.valid ? 'primary' : 'medium'"
          >
            <ion-spinner *ngIf="isSubmitting" name="crescent"></ion-spinner>
            <span *ngIf="!isSubmitting">
              <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
              Signaler le problème
            </span>
          </ion-button>
          
          <p class="note">
            Une fois signalé, notre équipe prendra contact avec vous dans les plus brefs délais.
          </p>
        </div>
      </ion-card-content>
    </ion-card>
  </form>
</ion-content>